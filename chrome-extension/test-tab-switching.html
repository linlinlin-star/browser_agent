<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ‡ç­¾é¡µåˆ‡æ¢æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .test-section h2 {
      color: #555;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .console-panel {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }
    
    .console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }
    
    .console-tabs {
      display: flex;
      gap: 4px;
      padding: 8px 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }
    
    .console-tab {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #666;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .console-tab:hover {
      background: #e9ecef;
    }
    
    .console-tab.active {
      background: #007bff;
      color: white;
    }
    
    .console-content {
      min-height: 400px;
      padding: 16px;
      background: white;
    }
    
    .console-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: #999;
    }
    
    .console-entry {
      display: flex;
      gap: 12px;
      padding: 8px;
      margin-bottom: 4px;
      border-left: 3px solid #007bff;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .console-entry.success {
      border-left-color: #28a745;
    }
    
    .console-entry.warning {
      border-left-color: #ffc107;
    }
    
    .console-entry.error {
      border-left-color: #dc3545;
    }
    
    .console-time {
      color: #666;
      font-family: monospace;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .console-text {
      flex: 1;
      color: #333;
    }
    
    .file-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .file-item:hover {
      border-color: #007bff;
      box-shadow: 0 2px 8px rgba(0,123,255,0.2);
    }
    
    .file-icon {
      font-size: 24px;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .file-meta {
      font-size: 12px;
      color: #666;
    }
    
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    button.secondary:hover {
      background: #545b62;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .status {
      padding: 12px;
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .status.success {
      background: #d4edda;
      border-left-color: #28a745;
    }
    
    .status.error {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
  </style>
</head>
<body>
  <h1>ğŸ”„ æ ‡ç­¾é¡µåˆ‡æ¢æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>æµ‹è¯•è¯´æ˜</h2>
    <div class="status">
      <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li>Current Session æ ‡ç­¾é¡µåªæ˜¾ç¤ºæ‰§è¡Œæ—¥å¿—</li>
        <li>Files æ ‡ç­¾é¡µåªæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨</li>
        <li>åˆ‡æ¢æ ‡ç­¾é¡µæ—¶å†…å®¹æ­£ç¡®åˆ‡æ¢</li>
        <li>æ—¥å¿—åœ¨åˆ‡æ¢åèƒ½æ­£ç¡®æ¢å¤</li>
      </ul>
    </div>
  </div>
  
  <div class="test-section">
    <h2>æ“ä½œæŒ‰é’®</h2>
    <div class="button-group">
      <button onclick="addTestLog()">æ·»åŠ æµ‹è¯•æ—¥å¿—</button>
      <button onclick="addMultipleLogs()">æ·»åŠ å¤šæ¡æ—¥å¿—</button>
      <button onclick="generateTestFile()">ç”Ÿæˆæµ‹è¯•æ–‡ä»¶</button>
      <button onclick="generateMultipleFiles()">ç”Ÿæˆå¤šä¸ªæ–‡ä»¶</button>
      <button class="secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
      <button class="secondary" onclick="clearFiles()">æ¸…ç©ºæ–‡ä»¶</button>
    </div>
  </div>
  
  <div class="test-section">
    <h2>æ§åˆ¶å°é¢æ¿</h2>
    <div class="console-panel">
      <div class="console-header">
        <h3 style="margin: 0; font-size: 16px;">æ‰§è¡Œæ§åˆ¶å°</h3>
        <button class="secondary" onclick="clearCurrentView()">æ¸…ç©ºå½“å‰è§†å›¾</button>
      </div>
      
      <div class="console-tabs">
        <button class="console-tab active" data-tab="session" onclick="switchTab('session')">
          Current Session
        </button>
        <button class="console-tab" data-tab="files" onclick="switchTab('files')">
          Files
        </button>
      </div>
      
      <div class="console-content" id="console-content">
        <div class="console-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 9h6M9 13h6M9 17h4"/>
          </svg>
          <p style="margin-top: 12px;">æ§åˆ¶å°è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="test-section">
    <h2>æµ‹è¯•ç»“æœ</h2>
    <div id="test-results"></div>
  </div>

  <script src="document-generator.js"></script>
  <script src="file-manager.js"></script>
  <script>
    // åˆå§‹åŒ–
    const fileManager = new FileManager();
    fileManager.loadFromStorage();
    const documentGenerator = new DocumentGenerator();
    
    // æ—¥å¿—å†å²
    window.sessionLogs = [];
    
    // å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µ
    let currentTab = 'session';
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      currentTab = tabName;
      
      // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.console-tab').forEach(tab => {
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // åˆ‡æ¢å†…å®¹
      if (tabName === 'session') {
        renderSessionLogs();
        logTestResult('âœ… åˆ‡æ¢åˆ° Current Session æ ‡ç­¾é¡µ', 'success');
      } else if (tabName === 'files') {
        renderFileList();
        logTestResult('âœ… åˆ‡æ¢åˆ° Files æ ‡ç­¾é¡µ', 'success');
      }
    }
    
    // æ¸²æŸ“ä¼šè¯æ—¥å¿—
    function renderSessionLogs() {
      const consoleContent = document.getElementById('console-content');
      
      if (window.sessionLogs.length === 0) {
        consoleContent.innerHTML = `
          <div class="console-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M9 9h6M9 13h6M9 17h4"/>
            </svg>
            <p style="margin-top: 12px;">æ§åˆ¶å°è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
          </div>
        `;
        return;
      }
      
      consoleContent.innerHTML = '';
      window.sessionLogs.forEach(log => {
        const entry = document.createElement('div');
        entry.className = `console-entry ${log.type}`;
        
        const time = document.createElement('div');
        time.className = 'console-time';
        time.textContent = log.time;
        
        const text = document.createElement('div');
        text.className = 'console-text';
        text.textContent = log.text;
        
        entry.appendChild(time);
        entry.appendChild(text);
        consoleContent.appendChild(entry);
      });
      
      consoleContent.scrollTop = consoleContent.scrollHeight;
    }
    
    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
    function renderFileList() {
      const consoleContent = document.getElementById('console-content');
      const files = fileManager.getFiles();
      
      if (files.length === 0) {
        consoleContent.innerHTML = `
          <div class="console-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p style="margin-top: 12px;">æš‚æ— ç”Ÿæˆçš„æ–‡ä»¶</p>
          </div>
        `;
        return;
      }
      
      let html = '<div class="file-list">';
      files.forEach(file => {
        const icon = file.type === 'csv' ? 'ğŸ“Š' : 'ğŸ“„';
        const date = new Date(file.createdAt).toLocaleString('zh-CN');
        const sizeKB = (file.size / 1024).toFixed(2);
        
        html += `
          <div class="file-item">
            <div class="file-icon">${icon}</div>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-meta">${date} Â· ${sizeKB} KB</div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      consoleContent.innerHTML = html;
    }
    
    // æ·»åŠ æ—¥å¿—
    function addLog(text, type = 'info') {
      const logEntry = {
        time: new Date().toLocaleTimeString('zh-CN', { 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit',
          fractionalSecondDigits: 3
        }),
        text: text,
        type: type
      };
      
      window.sessionLogs.push(logEntry);
      
      // åªåœ¨ Current Session æ ‡ç­¾é¡µæ—¶æ˜¾ç¤º
      if (currentTab === 'session') {
        renderSessionLogs();
      }
    }
    
    // æ·»åŠ æµ‹è¯•æ—¥å¿—
    function addTestLog() {
      const messages = [
        '[Agent] å¼€å§‹æ‰§è¡Œä»»åŠ¡',
        '[Agent] æ­£åœ¨åˆ†æé¡µé¢ç»“æ„',
        '[Agent] æå–æ•°æ®å®Œæˆ',
        '[Agent] ç”Ÿæˆæ–‡æ¡£ä¸­...',
        '[Agent] ä»»åŠ¡å®Œæˆ'
      ];
      
      const types = ['info', 'info', 'success', 'info', 'success'];
      const randomIndex = Math.floor(Math.random() * messages.length);
      
      addLog(messages[randomIndex], types[randomIndex]);
      logTestResult('âœ… æ·»åŠ äº†ä¸€æ¡æµ‹è¯•æ—¥å¿—', 'success');
    }
    
    // æ·»åŠ å¤šæ¡æ—¥å¿—
    function addMultipleLogs() {
      addLog('[Agent] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ', 'info');
      setTimeout(() => addLog('[Agent] æ­£åœ¨å¤„ç†æ•°æ®...', 'info'), 100);
      setTimeout(() => addLog('[Agent] æ•°æ®å¤„ç†å®Œæˆ', 'success'), 200);
      setTimeout(() => addLog('[Agent] å¼€å§‹ç”Ÿæˆæ–‡ä»¶', 'info'), 300);
      setTimeout(() => addLog('[Agent] æ–‡ä»¶ç”ŸæˆæˆåŠŸ', 'success'), 400);
      
      logTestResult('âœ… æ·»åŠ äº† 5 æ¡æµ‹è¯•æ—¥å¿—', 'success');
    }
    
    // ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
    async function generateTestFile() {
      try {
        const data = [
          ['å§“å', 'å¹´é¾„', 'åŸå¸‚'],
          ['å¼ ä¸‰', '25', 'åŒ—äº¬'],
          ['æå››', '30', 'ä¸Šæµ·']
        ];
        
        const blob = await documentGenerator.generateExcel(data, 'test.csv');
        fileManager.addFile({
          name: 'test.csv',
          type: 'csv',
          data: data,
          blob: blob,
          size: blob.size
        });
        
        addLog('[FILE] æ–‡ä»¶å·²ç”Ÿæˆ: test.csv', 'success');
        
        if (currentTab === 'files') {
          renderFileList();
        }
        
        logTestResult('âœ… ç”Ÿæˆäº†ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶', 'success');
      } catch (error) {
        logTestResult('âŒ æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ç”Ÿæˆå¤šä¸ªæ–‡ä»¶
    async function generateMultipleFiles() {
      try {
        for (let i = 1; i <= 3; i++) {
          const data = [
            ['åˆ—1', 'åˆ—2'],
            [`æ•°æ®${i}-1`, `æ•°æ®${i}-2`]
          ];
          
          const blob = await documentGenerator.generateExcel(data, `file_${i}.csv`);
          fileManager.addFile({
            name: `file_${i}.csv`,
            type: 'csv',
            data: data,
            blob: blob,
            size: blob.size
          });
          
          addLog(`[FILE] æ–‡ä»¶å·²ç”Ÿæˆ: file_${i}.csv`, 'success');
        }
        
        if (currentTab === 'files') {
          renderFileList();
        }
        
        logTestResult('âœ… ç”Ÿæˆäº† 3 ä¸ªæµ‹è¯•æ–‡ä»¶', 'success');
      } catch (error) {
        logTestResult('âŒ æ‰¹é‡ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
      window.sessionLogs = [];
      if (currentTab === 'session') {
        renderSessionLogs();
      }
      logTestResult('âœ… æ—¥å¿—å·²æ¸…ç©º', 'success');
    }
    
    // æ¸…ç©ºæ–‡ä»¶
    function clearFiles() {
      fileManager.clearAll();
      if (currentTab === 'files') {
        renderFileList();
      }
      addLog('[FILE] æ‰€æœ‰æ–‡ä»¶å·²æ¸…ç©º', 'warning');
      logTestResult('âœ… æ–‡ä»¶å·²æ¸…ç©º', 'success');
    }
    
    // æ¸…ç©ºå½“å‰è§†å›¾
    function clearCurrentView() {
      if (currentTab === 'session') {
        clearLogs();
      } else {
        clearFiles();
      }
    }
    
    // è®°å½•æµ‹è¯•ç»“æœ
    function logTestResult(message, type = 'info') {
      const results = document.getElementById('test-results');
      const entry = document.createElement('div');
      entry.className = `status ${type}`;
      entry.innerHTML = `
        <strong>[${new Date().toLocaleTimeString('zh-CN')}]</strong> ${message}
      `;
      results.appendChild(entry);
      results.scrollTop = results.scrollHeight;
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      logTestResult('âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œé»˜è®¤æ˜¾ç¤º Current Session æ ‡ç­¾é¡µ', 'success');
    });
  </script>
</body>
</html>
