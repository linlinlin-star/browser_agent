# 文件管理功能说明

## 功能概览

本系统提供了完整的文件管理功能，包括预览、编辑、删除、搜索、过滤等操作。

## 核心功能

### 1. 文件预览

#### CSV 文件预览
- **表格视图**: 以可编辑的表格形式显示 CSV 数据
- **实时编辑**: 直接在表格单元格中编辑内容
- **表头编辑**: 支持编辑列标题
- **行操作**: 每行都有删除按钮
- **添加行**: 可以动态添加新行
- **统计信息**: 显示行数和列数

**操作步骤**:
1. 在文件列表中点击"预览"按钮
2. 在表格中直接点击单元格进行编辑
3. 点击"添加行"按钮添加新数据行
4. 点击行末的删除按钮删除该行
5. 编辑完成后点击"保存更改"

#### HTML 文件预览
- **双视图模式**: 
  - 预览模式: 在 iframe 中渲染 HTML
  - 源代码模式: 显示 HTML 源代码
- **视图切换**: 通过标签页切换预览和源代码
- **实时渲染**: HTML 内容实时渲染显示

**操作步骤**:
1. 在文件列表中点击"预览"按钮
2. 默认显示预览模式
3. 点击"源代码"标签查看 HTML 源码
4. 点击"预览"标签返回渲染视图

### 2. 文件编辑

#### CSV 编辑功能
```javascript
// 编辑单元格
- 点击任意单元格开始编辑
- 输入新内容
- 点击其他地方或按 Tab 键保存

// 添加行
- 点击"添加行"按钮
- 新行会添加到表格末尾
- 所有单元格初始为空

// 删除行
- 点击行末的删除按钮
- 确认后删除该行
- 表头行不能删除

// 保存更改
- 点击"保存更改"按钮
- 更改会保存到 localStorage
- 显示保存成功提示
```

#### 编辑特性
- **即时反馈**: 编辑时单元格高亮显示
- **自动保存**: 失焦时自动保存单元格内容
- **批量保存**: 点击"保存更改"统一保存所有修改
- **撤销支持**: 可以取消编辑返回文件列表

### 3. 文件操作

#### 重命名
```javascript
// 使用方法
1. 在预览页面点击文件名旁的重命名按钮
2. 输入新的文件名
3. 确认后立即生效

// 代码示例
fileManager.renameFile(fileId, newName);
```

#### 复制
```javascript
// 使用方法
1. 在文件列表点击"复制"按钮
2. 自动创建副本，文件名添加"(副本)"后缀
3. 副本包含原文件的所有数据

// 代码示例
const newFileId = fileManager.duplicateFile(fileId);
```

#### 下载
```javascript
// 使用方法
1. 点击"下载"按钮
2. 浏览器自动下载文件
3. CSV 文件包含 UTF-8 BOM，支持中文

// 代码示例
fileManager.downloadFile(fileId);
```

#### 删除
```javascript
// 使用方法
1. 点击"删除"按钮
2. 显示确认对话框，包含文件详细信息
3. 确认后永久删除（无法恢复）

// 增强的删除确认
- 显示文件名
- 显示文件类型
- 显示文件大小
- 显示创建时间
- 警告无法撤销
```

### 4. 搜索和过滤

#### 搜索功能
```javascript
// 实时搜索
- 在搜索框输入关键词
- 自动过滤匹配的文件
- 支持文件名和类型搜索
- 不区分大小写

// 代码示例
const results = fileManager.searchFiles(query);
```

#### 类型过滤
```javascript
// 过滤选项
- 全部: 显示所有文件
- CSV: 只显示 CSV 文件
- HTML: 只显示 HTML 文件

// 代码示例
const csvFiles = fileManager.filterByType('csv');
```

#### 组合使用
- 搜索和过滤可以同时使用
- 先应用搜索，再应用过滤
- 实时更新文件列表

### 5. 批量操作

#### 批量删除
```javascript
// 使用方法
const fileIds = ['file_1', 'file_2', 'file_3'];
const deletedCount = fileManager.deleteFiles(fileIds);
console.log(`已删除 ${deletedCount} 个文件`);
```

#### 清空所有文件
```javascript
// 使用方法
fileManager.clearAll();
// 删除所有文件并清空存储
```

### 6. 统计信息

#### 获取统计
```javascript
const stats = fileManager.getStats();

// 返回结构
{
  totalFiles: 10,           // 总文件数
  totalSize: 1024000,       // 总大小（字节）
  byType: {
    csv: {
      count: 6,             // CSV 文件数
      size: 512000          // CSV 总大小
    },
    html: {
      count: 4,             // HTML 文件数
      size: 512000          // HTML 总大小
    }
  }
}
```

#### 显示统计
- 总文件数
- 总大小（MB）
- 各类型文件数量
- 各类型文件大小

## 用户界面

### 文件列表视图

```
┌─────────────────────────────────────┐
│  🔍 搜索框                          │
│  📊 统计信息: 10 个文件 · 2.5 MB   │
│  [全部] [📊 CSV] [📄 HTML]         │
├─────────────────────────────────────┤
│  📊 sample.csv                      │
│  2024-01-01 10:00 · 15.2 KB        │
│  [预览] [复制] [下载] [删除]       │
├─────────────────────────────────────┤
│  📄 document.html                   │
│  2024-01-01 10:05 · 8.5 KB         │
│  [预览] [复制] [下载] [删除]       │
└─────────────────────────────────────┘
```

### CSV 预览视图

```
┌─────────────────────────────────────┐
│  [← 返回] sample.csv [✏️] [+] [↓]  │
├─────────────────────────────────────┤
│  姓名    │ 年龄  │ 城市  │ 操作    │
│  张三    │ 25   │ 北京  │ [🗑️]   │
│  李四    │ 30   │ 上海  │ [🗑️]   │
│  王五    │ 28   │ 广州  │ [🗑️]   │
├─────────────────────────────────────┤
│  3 行 × 3 列    [取消] [保存更改]  │
└─────────────────────────────────────┘
```

### HTML 预览视图

```
┌─────────────────────────────────────┐
│  [← 返回] document.html [✏️] [👁️] [↓]│
│  [预览] [源代码]                    │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐ │
│  │  HTML 内容渲染区域            │ │
│  │  (iframe 显示)                │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

## 提示消息

### Toast 通知
- **位置**: 右下角
- **类型**: 
  - 成功 (绿色边框)
  - 警告 (黄色边框)
  - 错误 (红色边框)
  - 信息 (蓝色边框)
- **持续时间**: 3 秒自动消失
- **动画**: 淡入淡出效果

### 使用示例
```javascript
showToast('文件已保存', 'success');
showToast('文件已删除', 'warning');
showToast('操作失败', 'error');
showToast('正在处理', 'info');
```

## 键盘快捷键

### 编辑模式
- **Tab**: 移动到下一个单元格
- **Shift + Tab**: 移动到上一个单元格
- **Enter**: 移动到下一行同列
- **Esc**: 取消编辑

### 列表模式
- **Ctrl/Cmd + F**: 聚焦搜索框
- **Esc**: 清除搜索

## 数据持久化

### 存储机制
```javascript
// 存储位置
localStorage['fileManager_files']

// 存储内容
- 文件元数据
- 文件数据（data 数组）
- 不存储 blob（太大）

// 加载时
- 从 localStorage 读取
- 重新生成 blob
```

### 存储限制
- localStorage 通常限制 5-10 MB
- 建议不要存储过大的文件
- 大文件建议下载后删除

## 性能优化

### 大文件处理
```javascript
// CSV 文件
- 支持大型表格（100+ 行）
- 虚拟滚动（未来优化）
- 分页显示（未来优化）

// HTML 文件
- iframe 隔离渲染
- 避免 XSS 攻击
- 安全的内容显示
```

### 渲染优化
- 使用 DocumentFragment 批量插入
- 事件委托减少监听器
- 防抖搜索输入
- 懒加载文件列表

## 安全性

### XSS 防护
```javascript
// HTML 转义
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// iframe 隔离
<iframe sandbox="allow-same-origin"></iframe>
```

### 数据验证
- 文件名验证
- 文件类型检查
- 数据格式验证
- 大小限制检查

## 错误处理

### 常见错误
```javascript
// 文件不存在
if (!file) {
  showToast('文件不存在', 'error');
  return;
}

// 存储失败
try {
  localStorage.setItem(key, value);
} catch (error) {
  showToast('存储空间不足', 'error');
}

// 生成失败
try {
  const blob = await generateFile();
} catch (error) {
  showToast('文件生成失败', 'error');
  console.error(error);
}
```

## 测试

### 测试页面
打开 `test-file-features.html` 进行功能测试：

1. **生成测试文件**
   - 示例 CSV
   - 大型 CSV (100行)
   - 示例 HTML
   - 批量生成

2. **搜索和过滤**
   - 实时搜索
   - 类型过滤
   - 组合使用

3. **文件操作**
   - 预览
   - 编辑
   - 重命名
   - 复制
   - 下载
   - 删除

4. **统计信息**
   - 实时更新
   - 分类统计

## 最佳实践

### 文件命名
```javascript
// 好的命名
'sales_report_2024.csv'
'user_data_export.csv'
'monthly_summary.html'

// 避免的命名
'文件1.csv'  // 不够描述性
'temp.csv'   // 临时文件应该及时删除
```

### 数据组织
```javascript
// CSV 数据结构
[
  ['列1', '列2', '列3'],  // 表头
  ['值1', '值2', '值3'],  // 数据行
  ['值4', '值5', '值6']
]

// HTML 数据结构
{
  title: '文档标题',
  paragraphs: ['段落1', '段落2'],
  tables: [
    [['表头1', '表头2'], ['数据1', '数据2']]
  ]
}
```

### 性能建议
1. 定期清理不需要的文件
2. 大文件下载后删除
3. 避免存储重复数据
4. 使用搜索和过滤快速定位

## 未来改进

### 计划功能
- [ ] 文件导入（上传现有文件）
- [ ] 文件导出为多种格式
- [ ] 批量编辑
- [ ] 版本历史
- [ ] 文件分享
- [ ] 云端同步
- [ ] 高级搜索（正则表达式）
- [ ] 文件标签和分类
- [ ] 拖拽排序
- [ ] 快捷键支持

### 性能优化
- [ ] 虚拟滚动
- [ ] 分页加载
- [ ] Web Worker 处理大文件
- [ ] IndexedDB 存储
- [ ] 压缩存储

## 故障排查

### 问题：文件无法保存
**解决方案**:
1. 检查 localStorage 是否已满
2. 清理不需要的文件
3. 检查浏览器控制台错误

### 问题：编辑后数据丢失
**解决方案**:
1. 确保点击了"保存更改"
2. 检查是否有 JavaScript 错误
3. 尝试刷新页面重新编辑

### 问题：搜索无结果
**解决方案**:
1. 检查搜索关键词拼写
2. 尝试部分匹配
3. 清除过滤器
4. 刷新文件列表

## 总结

本文件管理系统提供了完整的文件操作功能，包括：
- ✅ 预览和编辑
- ✅ 搜索和过滤
- ✅ 批量操作
- ✅ 统计信息
- ✅ 数据持久化
- ✅ 用户友好的界面
- ✅ 完善的错误处理

通过这些功能，用户可以高效地管理生成的文档文件。
