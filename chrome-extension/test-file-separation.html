<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•æ–‡ä»¶å’Œæ—¥å¿—åˆ†ç¦»</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .section h2 {
      margin-top: 0;
      color: #333;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .log-area {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #007bff;
      background: white;
    }
    .file-list {
      list-style: none;
      padding: 0;
    }
    .file-item {
      padding: 10px;
      margin: 5px 0;
      background: #f9f9f9;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-info {
      flex: 1;
    }
    .file-actions button {
      padding: 5px 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>æµ‹è¯•æ–‡ä»¶å’Œæ—¥å¿—åˆ†ç¦»</h1>
  
  <div class="section">
    <h2>1. ç”Ÿæˆæµ‹è¯•æ–‡ä»¶</h2>
    <button onclick="generateTestCSV()">ç”Ÿæˆ CSV æ–‡ä»¶</button>
    <button onclick="generateTestHTML()">ç”Ÿæˆ HTML æ–‡ä»¶</button>
  </div>

  <div class="section">
    <h2>2. æ§åˆ¶å°æ—¥å¿—ï¼ˆä»…æ˜¾ç¤ºæ—¥å¿—ï¼Œä¸æ··å…¥æ–‡ä»¶ï¼‰</h2>
    <div class="log-area" id="log-area">
      <div style="color: #999;">æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>
    <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div class="section">
    <h2>3. æ–‡ä»¶åˆ—è¡¨ï¼ˆä»…æ˜¾ç¤ºæ–‡ä»¶ï¼Œä¸åŒ…å«æ—¥å¿—ï¼‰</h2>
    <ul class="file-list" id="file-list">
      <li style="color: #999;">æ–‡ä»¶å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</li>
    </ul>
    <button onclick="refreshFileList()">åˆ·æ–°åˆ—è¡¨</button>
    <button onclick="clearAllFiles()">æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶</button>
  </div>

  <script src="document-generator.js"></script>
  <script src="file-manager.js"></script>
  <script>
    // åˆå§‹åŒ–
    const fileManager = new FileManager();
    fileManager.loadFromStorage();
    const documentGenerator = new DocumentGenerator();

    // æ·»åŠ æ—¥å¿—ï¼ˆä»…åœ¨æ§åˆ¶å°æ˜¾ç¤ºï¼‰
    function addLog(message, type = 'info') {
      const logArea = document.getElementById('log-area');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const time = new Date().toLocaleTimeString('zh-CN');
      entry.innerHTML = `<strong>[${time}]</strong> ${message}`;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
      
      // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // ç”Ÿæˆæµ‹è¯• CSV æ–‡ä»¶
    async function generateTestCSV() {
      try {
        addLog('å¼€å§‹ç”Ÿæˆ CSV æ–‡ä»¶...', 'info');
        
        const testData = [
          ['å§“å', 'å¹´é¾„', 'åŸå¸‚'],
          ['å¼ ä¸‰', '25', 'åŒ—äº¬'],
          ['æå››', '30', 'ä¸Šæµ·'],
          ['ç‹äº”', '28', 'å¹¿å·']
        ];
        
        const blob = await documentGenerator.generateExcel(testData, 'test.csv');
        addLog(`CSV æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå¤§å°: ${blob.size} å­—èŠ‚`, 'success');
        
        // ä¿å­˜åˆ° FileManager
        const fileId = fileManager.addFile({
          name: 'test.csv',
          type: 'csv',
          data: testData,
          blob: blob,
          size: blob.size
        });
        
        addLog(`æ–‡ä»¶å·²ä¿å­˜åˆ° FileManagerï¼ŒID: ${fileId}`, 'success');
        refreshFileList();
        
      } catch (error) {
        addLog(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
      }
    }

    // ç”Ÿæˆæµ‹è¯• HTML æ–‡ä»¶
    async function generateTestHTML() {
      try {
        addLog('å¼€å§‹ç”Ÿæˆ HTML æ–‡ä»¶...', 'info');
        
        const testContent = {
          title: 'æµ‹è¯•æ–‡æ¡£',
          paragraphs: ['è¿™æ˜¯ç¬¬ä¸€æ®µå†…å®¹', 'è¿™æ˜¯ç¬¬äºŒæ®µå†…å®¹'],
          tables: [[
            ['åˆ—1', 'åˆ—2', 'åˆ—3'],
            ['æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3']
          ]]
        };
        
        const blob = await documentGenerator.generateWord(testContent, 'test.html');
        addLog(`HTML æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼Œå¤§å°: ${blob.size} å­—èŠ‚`, 'success');
        
        // ä¿å­˜åˆ° FileManager
        const fileId = fileManager.addFile({
          name: 'test.html',
          type: 'html',
          data: testContent,
          blob: blob,
          size: blob.size
        });
        
        addLog(`æ–‡ä»¶å·²ä¿å­˜åˆ° FileManagerï¼ŒID: ${fileId}`, 'success');
        refreshFileList();
        
      } catch (error) {
        addLog(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
      }
    }

    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    function refreshFileList() {
      const fileList = document.getElementById('file-list');
      const files = fileManager.getFiles();
      
      if (files.length === 0) {
        fileList.innerHTML = '<li style="color: #999;">æš‚æ— æ–‡ä»¶</li>';
        return;
      }
      
      fileList.innerHTML = '';
      files.forEach(file => {
        const li = document.createElement('li');
        li.className = 'file-item';
        
        const info = document.createElement('div');
        info.className = 'file-info';
        const icon = file.type === 'csv' ? 'ğŸ“Š' : 'ğŸ“„';
        const date = new Date(file.createdAt).toLocaleString('zh-CN');
        info.innerHTML = `
          <div><strong>${icon} ${file.name}</strong></div>
          <div style="font-size: 12px; color: #666;">
            ç±»å‹: ${file.type.toUpperCase()} | å¤§å°: ${file.size} å­—èŠ‚ | åˆ›å»ºæ—¶é—´: ${date}
          </div>
        `;
        
        const actions = document.createElement('div');
        actions.className = 'file-actions';
        actions.innerHTML = `
          <button onclick="downloadFile('${file.id}')">ä¸‹è½½</button>
          <button onclick="deleteFile('${file.id}')" style="background: #dc3545;">åˆ é™¤</button>
        `;
        
        li.appendChild(info);
        li.appendChild(actions);
        fileList.appendChild(li);
      });
      
      addLog(`æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°ï¼Œå…± ${files.length} ä¸ªæ–‡ä»¶`, 'info');
    }

    // ä¸‹è½½æ–‡ä»¶
    function downloadFile(fileId) {
      fileManager.downloadFile(fileId);
      const file = fileManager.getFile(fileId);
      addLog(`æ–‡ä»¶å·²ä¸‹è½½: ${file.name}`, 'success');
    }

    // åˆ é™¤æ–‡ä»¶
    function deleteFile(fileId) {
      const file = fileManager.getFile(fileId);
      if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${file.name}" å—ï¼Ÿ`)) {
        fileManager.deleteFile(fileId);
        addLog(`æ–‡ä»¶å·²åˆ é™¤: ${file.name}`, 'warning');
        refreshFileList();
      }
    }

    // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶
    function clearAllFiles() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
        fileManager.clearAll();
        addLog('æ‰€æœ‰æ–‡ä»¶å·²æ¸…ç©º', 'warning');
        refreshFileList();
      }
    }

    // æ¸…ç©ºæ—¥å¿—
    function clearLogs() {
      const logArea = document.getElementById('log-area');
      logArea.innerHTML = '<div style="color: #999;">æ—¥å¿—å·²æ¸…ç©º</div>';
    }

    // é¡µé¢åŠ è½½æ—¶åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
    window.addEventListener('DOMContentLoaded', () => {
      addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
      refreshFileList();
    });
  </script>
</body>
</html>
